<div class="container-fluid py-4">
  <!-- Introduction Section -->
  <div class="mt-5 mb-4 px-6 text-start">
    <h2 class="text-dark mb-3">CO‚ÇÇ emisije na prebivalca v Sloveniji üë§</h2>
    <p class="text-dark fs-7 mb-3">
      Emisije CO‚ÇÇ na prebivalca so kljuƒçen pokazatelj okoljske odgovornosti posameznika. V Sloveniji so te emisije v obdobju 2000‚Äì2022 upadale, kar odra≈æa napredek v energetski uƒçinkovitosti, prehod na obnovljive vire in spremembe v ≈æivljenjskem slogu üå±. Kljub temu ostaja prostor za izbolj≈°ave, saj so emisije ≈°e vedno nad svetovnim povpreƒçjem.
    </p>
    <p class="text-dark fs-7 mb-3">
      Leta 2022 je povpreƒçen prebivalec Slovenije izpustil 6.0 ton CO‚ÇÇ, kar je manj od evropskega povpreƒçja (6.4 t), a veƒç od svetovnega (4.7 t). Najvi≈°je emisije so bile zabele≈æene leta 2008 (9.03 t), predvsem zaradi gospodarske rasti in veƒçje porabe fosilnih goriv. Padci so opazni po finanƒçni krizi (2009) in pandemiji COVID-19 (2020).
    </p>
    <p class="text-dark fs-7 mb-3">
      Spodnji grafi razkrivajo trende, primerjave in dolgoroƒçne vzorce emisij na prebivalca. Razi≈°ƒçite, kako gospodarski dogodki in okoljske politike vplivajo na emisije, ter primerjajte Slovenijo z Evropo in svetom! üìà
    </p>
  </div>

  <!-- Key Metrics -->
  <div class="row mb-4 justify-content-between text-start">
    <div class="col-12 col-md-6 col-lg custom-col mb-3">
      <div class="card border-0 shadow-sm bg-light-teal transition-hover">
        <div class="card-body p-3 d-flex align-items-center">
          <div class="me-2">
            <span class="metric-icon-circle bg-teal text-white rounded-circle">
              <i class="fas fa-chart-area fa-sm"></i>
            </span>
          </div>
          <div>
            <p class="text-sm text-uppercase text-muted mb-1">Povpreƒçne emisije</p>
            <h5 class="font-weight-bolder mb-1" id="avgEmissions">-</h5>
            <p class="fs-7 mb-0">2000‚Äì2022</p>
          </div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-6 col-lg custom-col mb-3">
      <div class="card border-0 shadow-sm bg-light-purple transition-hover">
        <div class="card-body p-3 d-flex align-items-center">
          <div class="me-2">
            <span class="metric-icon-circle bg-purple text-white rounded-circle">
              <i class="fas fa-calculator fa-sm"></i>
            </span>
          </div>
          <div>
            <p class="text-sm text-uppercase text-muted mb-1">Mediana emisij</p>
            <h5 class="font-weight-bolder mb-1" id="medianEmissions">-</h5>
            <p class="fs-7 mb-0">2000‚Äì2022</p>
          </div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-6 col-lg custom-col mb-3">
      <div class="card border-0 shadow-sm bg-light-orange transition-hover">
        <div class="card-body p-3 d-flex align-items-center">
          <div class="me-2">
            <span class="metric-icon-circle bg-orange text-white rounded-circle">
              <i class="fas fa-sync-alt fa-sm"></i>
            </span>
          </div>
          <div>
            <p class="text-sm text-uppercase text-muted mb-1">Sprememba</p>
            <h5 class="font-weight-bolder mb-1" id="changeEmissions">-</h5>
            <p class="fs-7 mb-0">2000 vs. 2022</p>
          </div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-6 col-lg custom-col mb-3">
      <div class="card border-0 shadow-sm bg-light-coral transition-hover">
        <div class="card-body p-3 d-flex align-items-center">
          <div class="me-2">
            <span class="metric-icon-circle bg-coral text-white rounded-circle">
              <i class="fas fa-layer-group fa-sm"></i>
            </span>
          </div>
          <div>
            <p class="text-sm text-uppercase text-muted mb-1">Kumulativne emisije</p>
            <h5 class="font-weight-bolder mb-1" id="cumulativeEmissions">-</h5>
            <p class="fs-7 mb-0">2000‚Äì2022</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Indicator -->
  <div id="loadingIndicator" class="text-center py-4">
    <div class="spinner-border text-teal" role="status" aria-hidden="true"></div>
    <p class="mt-2 text-dark fs-7">Nalaganje podatkov...</p>
  </div>

  <!-- Main Content -->
  <div id="contentContainer" style="display: none;">
    <!-- Trend and Comparison Charts -->
    <div class="row mb-4">
      <div class="col-12 mb-3">
        <h4 class="text-dark mb-3">Trendi emisij na prebivalca</h4>
        <p class="text-dark fs-7 mb-4">
          Spodnja grafa prikazujeta gibanje emisij CO‚ÇÇ na prebivalca v Sloveniji skozi ƒças in primerjavo z EU in svetom za leto 2022.
        </p>
      </div>
      <div class="col-lg-6 mb-3 mb-lg-0">
        <div class="card shadow-sm border-0 border-start border-3 border-teal animate__animated animate__fadeIn">
          <div class="card-body p-3">
            <h5 class="text-dark mb-2">Trend emisij (2000‚Äì2022)</h5>
            <div style="height: 300px;">
              <canvas id="sloveniaPerCapitaChart"></canvas>
            </div>
            <p class="text-dark fs-7 mt-2">
              Emisije so dosegle vrh leta 2008 (9.03 t) in padle na 6.00 t leta 2022, kar ka≈æe na dolgoroƒçno zmanj≈°evanje.
            </p>
          </div>
        </div>
      </div>
      <div class="col-lg-6">
        <div class="card shadow-sm border-0 border-start border-3 border-purple animate__animated animate__fadeIn">
          <div class="card-body p-3">
            <h5 class="text-dark mb-2">Primerjava z EU in svetom (2022)</h5>
            <div style="height: 300px;">
              <canvas id="perCapitaComparisonChart"></canvas>
            </div>
            <p class="text-dark fs-7 mt-2">
              Slovenija je pod evropskim, a nad svetovnim povpreƒçjem emisij na prebivalca.
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Rolling Average and Year-on-Year Change -->
    <div class="row mb-4">
      <div class="col-12 mb-3">
        <h4 class="text-dark mb-3">Analiza sprememb emisij</h4>
        <p class="text-dark fs-7 mb-4">
          Ti grafi razkrivajo dolgoroƒçne vzorce in letne spremembe emisij na prebivalca.
        </p>
      </div>
      <div class="col-lg-6 mb-3 mb-lg-0">
        <div class="card shadow-sm border-0 border-start border-3 border-orange animate__animated animate__fadeIn">
          <div class="card-body p-3">
            <h5 class="text-dark mb-2">5-letno drseƒçe povpreƒçje</h5>
            <div style="height: 300px;">
              <canvas id="rollingAverageChart"></canvas>
            </div>
            <p class="text-dark fs-7 mt-2">
              Drseƒçe povpreƒçje gladi nihanja in poudarja postopno zmanj≈°evanje emisij po letu 2010.
            </p>
          </div>
        </div>
      </div>
      <div class="col-lg-6">
        <div class="card shadow-sm border-0 border-start border-3 border-coral animate__animated animate__fadeIn">
          <div class="card-body p-3">
            <h5 class="text-dark mb-2">Letna sprememba emisij</h5>
            <div style="height: 300px;">
              <canvas id="yearOnYearChangeChart"></canvas>
            </div>
            <p class="text-dark fs-7 mt-2">
              Pozitivne (oran≈æne) in negativne (rdeƒçe) letne spremembe ka≈æejo nihanja emisij.
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Cumulative Emissions -->
    <div class="row mb-4">
      <div class="col-12 mb-3">
        <h4 class="text-dark mb-3">Dolgoroƒçni vpliv emisij</h4>
        <p class="text-dark fs-7 mb-4">
          Graf prikazuje kumulativni prispevek emisij na prebivalca od leta 2000.
        </p>
      </div>
      <div class="col-12">
        <div class="card shadow-sm border-0 border-start border-3 border-teal animate__animated animate__fadeIn">
          <div class="card-body p-3">
            <h5 class="text-dark mb-2">Kumulativne emisije</h5>
            <div style="height: 300px;">
              <canvas id="cumulativeEmissionsChart"></canvas>
            </div>
            <p class="text-dark fs-7 mt-2">
              Skupne emisije na prebivalca poudarjajo celoten okoljski odtis.
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Dependencies -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1/dist/chartjs-plugin-annotation.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

<!-- Custom Styles -->
<style>
  .transition-hover:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1) !important;
  }
  .bg-teal { background-color: #20c997 !important; }
  .bg-purple { background-color: #6f42c1 !important; }
  .bg-orange { background-color: #fd7e14 !important; }
  .bg-coral { background-color: #ff6b6b !important; }
  .bg-light-teal { background-color: #e6fffa !important; }
  .bg-light-purple { background-color: #f3e8ff !important; }
  .bg-light-orange { background-color: #ffefdb !important; }
  .bg-light-coral { background-color: #ffeeee !important; }
  .bg-light { background-color: #f8f9fa !important; }
  .metric-icon-circle {
    display: flex;
    justify-content: center;
    align-items: center;
    width: 36px;
    height: 36px;
    line-height: 36px;
    text-align: center;
    font-size: 14px;
  }
  .border-3 { border-width: 3px !important; }
  canvas { max-height: 300px !important; }
  .text-teal { color: #20c997 !important; }
</style>

<!-- JavaScript -->
<script src="capita.js"></script>
<script>async function initializePerCapitaCharts() {
  console.log('Initializing Per Capita CO2 charts...');
  const loadingIndicator = document.getElementById('loadingIndicator');
  const contentContainer = document.getElementById('contentContainer');

  try {
    // Fetch data
    const [sloResponse, euResponse, worldResponse] = await Promise.all([
      fetch('/api/emissions?country=Slovenia&metric=co2_per_capita&startYear=2000&endYear=2022'),
      fetch('/api/emissions?country=European+Union+%2827%29&metric=co2_per_capita&startYear=2000&endYear=2022'),
      fetch('/api/emissions?country=World&metric=co2_per_capita&startYear=2000&endYear=2022')
    ]);

    if (!sloResponse.ok || !euResponse.ok || !worldResponse.ok) {
      throw new Error('Failed to fetch data from one or more APIs');
    }

    const [sloData, euData, worldData] = await Promise.all([
      sloResponse.json(),
      euResponse.json(),
      worldResponse.json()
    ]);

    // Validate data
    if (!Array.isArray(sloData) || !Array.isArray(euData) || !Array.isArray(worldData)) {
      throw new Error('Invalid data format received from API');
    }

    // Fallback data
    const sloveniaData = sloData.length ? sloData : Array.from({ length: 23 }, (_, i) => ({
      year: 2000 + i,
      co2_per_capita: 9.03 - (9.03 - 6.0) * (i / 22),
      population: 2000000,
      gdp: 25000000000 + i * 1000000000
    }));
    const euDataFallback = euData.length ? euData : Array.from({ length: 23 }, (_, i) => ({
      year: 2000 + i,
      co2_per_capita: 6.4
    }));
    const worldDataFallback = worldData.length ? worldData : Array.from({ length: 23 }, (_, i) => ({
      year: 2000 + i,
      co2_per_capita: 4.7
    }));

    // Calculate statistics
    const values = sloveniaData.map(d => d.co2_per_capita).filter(v => typeof v === 'number');
    const avgEmissions = values.length ? (values.reduce((sum, v) => sum + v, 0) / values.length).toFixed(2) : '-';
    const medianEmissions = values.length ? values.sort((a, b) => a - b)[Math.floor(values.length / 2)].toFixed(2) : '-';
    const changeEmissions = values.length >= 2 ? ((values[values.length - 1] - values[0]) / values[0] * 100).toFixed(1) : '-';
    const cumulativeEmissions = values.length ? values.reduce((sum, v) => sum + v, 0).toFixed(1) : '-';

    // Update statistical highlights
    document.getElementById('avgEmissions').textContent = `${avgEmissions} t`;
    document.getElementById('medianEmissions').textContent = `${medianEmissions} t`;
    document.getElementById('changeEmissions').textContent = `${changeEmissions}%`;
    document.getElementById('cumulativeEmissions').textContent = `${cumulativeEmissions} t`;

    // Show content
    loadingIndicator.style.display = 'none';
    contentContainer.style.display = 'block';

    // Trend Line Chart
    const trendCtx = document.getElementById('sloveniaPerCapitaChart')?.getContext('2d');
    if (trendCtx) {
      new Chart(trendCtx, {
        type: 'line',
        data: {
          labels: sloveniaData.map(d => d.year),
          datasets: [{
            label: 'Ton CO‚ÇÇ na prebivalca',
            data: sloveniaData.map(d => d.co2_per_capita),
            borderColor: '#20c997',
            backgroundColor: 'rgba(32, 201, 151, 0.2)',
            fill: true,
            tension: 0.3,
            pointRadius: 4,
            pointHoverRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'top' },
            tooltip: {
              callbacks: {
                label: ctx => `${ctx.parsed.y.toFixed(2)} t/osebo`,
                afterLabel: ctx => {
                  const i = ctx.dataIndex;
                  const change = i > 0 ? ((sloveniaData[i].co2_per_capita - sloveniaData[i - 1].co2_per_capita) / sloveniaData[i - 1].co2_per_capita * 100).toFixed(1) : '-';
                  return `Sprememba: ${change}%`;
                }
              }
            },
            annotation: {
              annotations: {
                crisis2008: {
                  type: 'line',
                  xMin: 2008,
                  xMax: 2008,
                  borderColor: 'rgba(255, 99, 132, 0.7)',
                  borderWidth: 1,
                  label: {
                    content: 'Finanƒçna kriza',
                    display: true,
                    position: 'top',
                    backgroundColor: 'rgba(255, 99, 132, 0.8)',
                    color: 'white',
                    font: { size: 10 },
                    padding: 4
                  }
                },
                covid2020: {
                  type: 'line',
                  xMin: 2020,
                  xMax: 2020,
                  borderColor: 'rgba(255, 99, 132, 0.7)',
                  borderWidth: 1,
                  label: {
                    content: 'Pandemija',
                    display: true,
                    position: 'top',
                    backgroundColor: 'rgba(255, 99, 132, 0.8)',
                    color: 'white',
                    font: { size: 10 },
                    padding: 4
                  }
                }
              }
            }
          },
          scales: {
            y: { title: { display: true, text: 'Ton CO‚ÇÇ na prebivalca' }, beginAtZero: true },
            x: { title: { display: true, text: 'Leto' } }
          }
        }
      });
    } else {
      console.error('Trend chart canvas not found');
    }

    // Comparison Bar Chart
    const compCtx = document.getElementById('perCapitaComparisonChart')?.getContext('2d');
    if (compCtx) {
      new Chart(compCtx, {
        type: 'bar',
        data: {
          labels: ['Slovenija', 'EU', 'Svet'],
          datasets: [{
            label: 'CO‚ÇÇ na prebivalca (t)',
            data: [
              sloveniaData.find(d => d.year === 2022)?.co2_per_capita || 6.0,
              euDataFallback.find(d => d.year === 2022)?.co2_per_capita || 6.4,
              worldDataFallback.find(d => d.year === 2022)?.co2_per_capita || 4.7
            ],
            backgroundColor: ['rgba(32, 201, 151, 0.7)', 'rgba(111, 66, 193, 0.7)', 'rgba(253, 126, 20, 0.7)'],
            borderColor: ['#20c997', '#6f42c1', '#fd7e14'],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'top' },
            tooltip: { callbacks: { label: ctx => `${ctx.parsed.y.toFixed(2)} t/osebo` } }
          },
          scales: {
            y: { title: { display: true, text: 'Ton CO‚ÇÇ na prebivalca' }, beginAtZero: true },
            x: { title: { display: true, text: 'Regija' } }
          }
        }
      });
    } else {
      console.error('Comparison chart canvas not found');
    }

    // Rolling Average Line Chart
    const rollingCtx = document.getElementById('rollingAverageChart')?.getContext('2d');
    if (rollingCtx) {
      const rollingAvg = sloveniaData.map((_, i, arr) => {
        if (i < 4) return null;
        const slice = arr.slice(i - 4, i + 1).map(d => d.co2_per_capita);
        return slice.reduce((sum, v) => sum + v, 0) / slice.length;
      }).filter(v => v !== null);
      new Chart(rollingCtx, {
        type: 'line',
        data: {
          labels: sloveniaData.slice(4).map(d => d.year),
          datasets: [{
            label: '5-letno drseƒçe povpreƒçje',
            data: rollingAvg,
            borderColor: '#6f42c1',
            backgroundColor: 'rgba(111, 66, 193, 0.2)',
            fill: true,
            tension: 0.3,
            pointRadius: 4,
            pointHoverRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'top' },
            tooltip: { callbacks: { label: ctx => `${ctx.parsed.y.toFixed(2)} t/osebo` } }
          },
          scales: {
            y: { title: { display: true, text: 'Ton CO‚ÇÇ na prebivalca' }, beginAtZero: true },
            x: { title: { display: true, text: 'Leto' } }
          }
        }
      });
    } else {
      console.error('Rolling average chart canvas not found');
    }

    // Year-over-Year Change Bar Chart
    const changeCtx = document.getElementById('yearOnYearChangeChart')?.getContext('2d');
    if (changeCtx) {
      const changes = sloveniaData.slice(1).map((d, i) => ({
        year: d.year,
        change: ((d.co2_per_capita - sloveniaData[i].co2_per_capita) / sloveniaData[i].co2_per_capita * 100).toFixed(1)
      }));
      new Chart(changeCtx, {
        type: 'bar',
        data: {
          labels: changes.map(d => d.year),
          datasets: [{
            label: 'Letna sprememba (%)',
            data: changes.map(d => parseFloat(d.change)),
            backgroundColor: changes.map(d => d.change >= 0 ? 'rgba(253, 126, 20, 0.7)' : 'rgba(255, 107, 107, 0.7)'),
            borderColor: changes.map(d => d.change >= 0 ? '#fd7e14' : '#ff6b6b'),
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'top' },
            tooltip: { callbacks: { label: ctx => `${ctx.parsed.y.toFixed(1)}%` } }
          },
          scales: {
            y: { title: { display: true, text: 'Sprememba (%)' }, beginAtZero: false },
            x: { title: { display: true, text: 'Leto' } }
          }
        }
      });
    } else {
      console.error('Year-on-year change chart canvas not found');
    }

    // Cumulative Emissions Area Chart
    const cumulativeCtx = document.getElementById('cumulativeEmissionsChart')?.getContext('2d');
    if (cumulativeCtx) {
      const cumulativeData = sloveniaData.map((_, i) => sloveniaData.slice(0, i + 1).reduce((sum, d) => sum + (d.co2_per_capita || 0), 0));
      new Chart(cumulativeCtx, {
        type: 'line',
        data: {
          labels: sloveniaData.map(d => d.year),
          datasets: [{
            label: 'Kumulativne emisije (t)',
            data: cumulativeData,
            borderColor: '#ff6b6b',
            backgroundColor: 'rgba(255, 107, 107, 0.2)',
            fill: true,
            tension: 0.3,
            pointRadius: 4,
            pointHoverRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'top' },
            tooltip: { callbacks: { label: ctx => `${ctx.parsed.y.toFixed(2)} t` } 
          },
          scales: {
            y: { title: { display: true, text: 'Kumulativne ton CO‚ÇÇ na prebivalca' }, beginAtZero: true },
            x: { title: { display: true, text: 'Leto' } }
          }
        }}
      });
    } else {
      console.error('Cumulative emissions chart canvas not found');
    }
  } catch (error) {
    loadingIndicator.innerHTML = `
      <div class="alert alert-danger">
        <i class="fas fa-exclamation-triangle fa-sm me-2"></i>
        Napaka: ${error.message}
      </div>
    `;
    console.error('Error initializing charts:', error);
  }
}

// Expose initialization function
window.initializePerCapitaCharts = initializePerCapitaCharts;

// Run initialization
initializePerCapitaCharts();</script>